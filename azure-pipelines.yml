trigger:
  branches:
    include:
      - main
      - features/*
    exclude:
      - prod

pool:
  name: akkc_agent

stages:
- stage: terraformInitandfmt
  displayName: "Terraform install, init and fmt"
  jobs:

    - job: terraformInstall
      displayName: "Install Terraform"
      steps:
        - task: TerraformInstaller@1
          displayName: "Install Terraform"
          inputs:
            terraformVersion: 'latest'

    - job: terraformInit
      displayName: "Terraform Init"
      dependsOn: terraformInstall
      steps:
        - task: TerraformTaskV2@2
          displayName: "Terraform Init"
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: '$(System.DefaultWorkingDirectory)/env/dev'
            backendServiceArm: 'akkc_agent_sp'
            backendAzureRmResourceGroupName: 'my-rg-test1'
            backendAzureRmStorageAccountName: 'demostorage9451'
            backendAzureRmContainerName: 'tfstate'
            backendAzureRmKey: 'dev.terraform.tfstate'
        - task: TerraformTask@5
          displayName: "Terraform fmt"
          inputs:
            provider: 'azurerm'
            command: 'custom'
            workingDirectory: '$(System.DefaultWorkingDirectory)/env/dev'
            outputTo: 'console'
            customCommand: 'fmt'
            environmentServiceNameAzureRM: 'akkc_agent_sp'
